# Руководство по настройке CI/CD

## Обзор

В данном репозитории настроены два GitHub Actions workflow:

1. **PR CI** (`.github/workflows/pr-ci.yml`) - Запускается при создании Pull Request в main
2. **Main CI** (`.github/workflows/main-ci.yml`) - Запускается при merge в ветку main

## Предварительные требования

### Необходимые секреты

Настройте следующие секреты в настройках репозитория GitHub (Settings → Secrets and variables → Actions):

- `DOCKER_USERNAME` - Ваше имя пользователя Docker Hub
- `DOCKER_PASSWORD` - Ваш пароль или токен доступа Docker Hub

### Необходимые метки

Создайте следующие метки в репозитории для управления версиями:
- `version:patch` - Увеличивает patch версию (0.1.0 → 0.1.1)
- `version:minor` - Увеличивает minor версию (0.1.0 → 0.2.0)
- `version:major` - Увеличивает major версию (0.1.0 → 1.0.0)
- `version:none` - Не увеличивать версию

## PR CI Workflow

### Триггер
- Запускается автоматически при каждом Pull Request в ветку `main`

### Шаги
1. Checkout кода
2. Настройка JDK 21
3. Сборка Java приложения с помощью Gradle
4. Сборка Docker образа
5. Запуск контейнера и ожидание healthcheck
6. Проверка healthcheck endpoint (`/healthz`)
7. Запуск сканера уязвимостей Trivy
8. Загрузка результатов безопасности в GitHub Security

### Требования
- Приложение должно успешно собираться
- Контейнер должен запускаться и проходить healthcheck
- Отсутствие критических/высоких уязвимостей (сканирование Trivy)

### Настройка как обязательной проверки
Чтобы сделать этот workflow обязательной проверкой для merge:
1. Перейдите в настройки репозитория Settings → Branches
2. Добавьте или отредактируйте правило защиты ветки для `main`
3. В разделе "Require status checks to pass before merging"
4. Установите флаг "Require branches to be up to date before merging"
5. Выберите "PR CI" из списка проверок статуса

## Main CI Workflow

### Триггер
- Запускается автоматически при каждом push в ветку `main` (после merge)

### Шаги
1. Checkout кода
2. Получение меток из merged PR для определения типа обновления версии
3. Обновление файла VERSION с помощью скрипта `update_version.sh`
4. Сборка Java приложения
5. Сборка Docker образа с тегом версии
6. Запуск контейнера и проверка healthcheck
7. Запуск сканера уязвимостей Trivy
8. Публикация Docker образа в Docker Hub (с тегом версии и `latest`)
9. Коммит обновленного файла VERSION обратно в репозиторий

### Управление версиями

Workflow читает метки из merged PR, чтобы определить, как обновить версию:

- **version:patch** - Увеличивает patch версию (например, 0.1.0 → 0.1.1)
- **version:minor** - Увеличивает minor версию, сбрасывает patch (например, 0.1.5 → 0.2.0)
- **version:major** - Увеличивает major версию, сбрасывает minor и patch (например, 0.2.3 → 1.0.0)
- **version:none** - Без изменения версии (использует текущую версию для Docker тега)

Если метка версии не найдена, по умолчанию используется `version:none`.

### Теги Docker образа

Workflow публикует образы со следующими тегами:
- `{DOCKER_USERNAME}/demo-app:{VERSION}` - Тег с конкретной версией
- `{DOCKER_USERNAME}/demo-app:latest` - Тег latest

### Файл VERSION

Файл `VERSION` в корне репозитория содержит текущую версию в формате semantic versioning (например, `0.1.0`). Этот файл автоматически обновляется workflow, когда на merged PR присутствует метка версии.

## Пример использования

1. Создайте feature ветку и внесите изменения
2. Создайте Pull Request в `main`
3. Добавьте метку версии к PR (например, `version:minor`)
4. PR CI workflow запускается автоматически и проверяет изменения
5. После одобрения и merge PR, Main CI workflow:
   - Обновляет версию на основе метки
   - Собирает и тестирует приложение
   - Публикует Docker образ с новой версией
   - Коммитит обновленный файл VERSION

## Решение проблем

### PR CI падает
- Проверьте логи сборки на ошибки компиляции
- Убедитесь, что healthcheck endpoint доступен
- Просмотрите результаты сканирования Trivy на предмет проблем безопасности

### Main CI не может найти метки PR
- Убедитесь, что PR был merged (не rebase напрямую в main)
- Проверьте, что метка названа правильно (например, `version:patch`)
- Проверьте логи workflow на предмет обнаружения номера PR

### Docker push падает
- Проверьте, что секреты `DOCKER_USERNAME` и `DOCKER_PASSWORD` настроены правильно
- Убедитесь, что учетные данные Docker Hub имеют права на push
- Проверьте, соответствует ли имя репозитория вашему репозиторию Docker Hub

## Файлы

- `.github/workflows/pr-ci.yml` - Определение PR workflow
- `.github/workflows/main-ci.yml` - Определение workflow для ветки main
- `update_version.sh` - Скрипт обновления версии
- `VERSION` - Файл с текущей версией
